<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0">
    <title>Quick Split - Expense Splitter</title>
    <style>
        :root {
            --primary-color: #2E7D32;
            --primary-light: #4CAF50;
            --secondary-color: #FFC107;
            --background-color: #f7f8fc;
            --card-background: #ffffff;
            --text-color: #333;
            --light-text-color: #666;
            --border-color: #e0e0e0;
            --danger-color: #d32f2f;
        }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            background-color: var(--background-color);
            color: var(--text-color);
            margin: 0;
            padding: 15px;
            font-size: 16px;
        }
        .container { max-width: 900px; margin: 0 auto; display: grid; grid-template-columns: 1fr; gap: 20px; }
        @media (min-width: 768px) { .container { grid-template-columns: 1fr 1fr; } }
        h1, h2 { color: var(--primary-color); border-bottom: 2px solid var(--border-color); padding-bottom: 10px; margin-top: 0; font-size: 1.5em; }
        h1 { font-size: 1.8em; }
        .card { background-color: var(--card-background); border-radius: 12px; box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08); padding: 20px; overflow: hidden; }
        .full-width { grid-column: 1 / -1; }
        .input-group { margin-bottom: 15px; }
        .input-group label { display: block; margin-bottom: 8px; font-weight: 600; }
        input[type="text"], input[type="number"], select { width: 100%; padding: 12px; border: 1px solid var(--border-color); border-radius: 8px; font-size: 1em; }
        input:focus, select:focus { outline: none; border-color: var(--primary-color); box-shadow: 0 0 0 2px rgba(46, 125, 50, 0.2); }
        button { background-color: var(--primary-light); color: white; border: none; padding: 14px 20px; border-radius: 8px; cursor: pointer; font-size: 1em; font-weight: 600; transition: background-color 0.2s ease, transform 0.1s ease; }
        button:hover { background-color: var(--primary-color); }
        button:active { transform: scale(0.98); }
        button.danger { background-color: var(--danger-color); font-size: 0.8em; padding: 5px 10px; }
        button.secondary { background-color: #6c757d; font-size: 0.9em; }
        button.secondary:hover { background-color: #5a6268; }
        #friends-list li, #payers-list li { background: #fafafa; padding: 12px; border: 1px solid var(--border-color); border-radius: 8px; margin-bottom: 8px; display: flex; justify-content: space-between; align-items: center; }
        #payers-list li { background: #e8f5e9; border-color: var(--primary-light); }
        #expenses-list li { background: #fafafa; padding: 12px; border: 1px solid var(--border-color); border-radius: 8px; margin-bottom: 8px; display: flex; flex-direction: column; transition: background-color 0.2s ease; cursor: pointer; }
        #expenses-list li:hover { background-color: #f5f5f5; }
        #expenses-list li.active { background-color: #f0f0f0; }
        .expense-header { display: flex; justify-content: space-between; align-items: center; width: 100%; }
        .expense-details b { font-size: 1.1em; }
        .expense-info { font-size: 0.9em; color: var(--light-text-color); word-break: break-word; }
        .expense-participants-list { font-size: 0.85em; color: #555; margin-top: 8px; padding-top: 8px; border-top: 1px dashed var(--border-color); width: 100%;}
        .expense-actions { display: flex; align-items: center; gap: 15px; }
        .toggle-arrow { font-size: 1.2em; color: var(--light-text-color); transition: transform 0.3s ease; }
        #expenses-list li.active .toggle-arrow { transform: rotate(180deg); }
        .expense-breakdown { display: none; margin-top: 10px; padding-top: 10px; border-top: 1px solid var(--border-color); }
        .expense-breakdown p { margin: 4px 0; font-size: 0.9em; }
        .expense-breakdown h4 { margin: 8px 0; font-size: 1em; color: var(--primary-color); }
        #expense-participants-checkboxes { max-height: 150px; overflow-y: auto; background: #f9f9f9; padding: 10px; border-radius: 8px; border: 1px solid var(--border-color); }
        #expense-participants-checkboxes label { display: block; margin-bottom: 8px; }
        #settlement-summary li { background: #e8f5e9; padding: 14px; border-radius: 8px; margin-bottom: 10px; list-style: none; }
        #settlement-summary li.placeholder { background: #f1f1f1; }
        .split-method-group { display: flex; gap: 20px; margin-bottom: 15px; }
        #unequal-split-container { display: none; background-color: #f9f9f9; border: 1px dashed var(--border-color); padding: 15px; border-radius: 8px; margin-top: 15px; }
        .unequal-split-row { display: flex; align-items: center; margin-bottom: 8px; gap: 10px; }
        .unequal-split-row label { flex: 1; }
        .unequal-split-row input { width: 100px; }
        #unequal-split-total { font-weight: bold; margin-top: 10px; text-align: right; }
        .add-payer-group { display: flex; gap: 10px; align-items: center; margin-bottom: 15px; }
        .add-payer-group select { flex-grow: 1; }
        .add-payer-group input { width: 120px; }
        #total-amount-display { font-size: 1.5em; font-weight: bold; color: var(--primary-color); }
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.5); display: flex; justify-content: center; align-items: center; z-index: 1000; opacity: 0; visibility: hidden; transition: opacity 0.2s ease, visibility 0.2s ease; }
        .modal-overlay.active { opacity: 1; visibility: visible; }
        .modal-content { background: white; padding: 25px; border-radius: 12px; width: 90%; max-width: 400px; text-align: center; transform: scale(0.95); transition: transform 0.2s ease; }
        .modal-overlay.active .modal-content { transform: scale(1); }
        .modal-buttons { margin-top: 20px; display: flex; gap: 10px; justify-content: center; }
        .button-secondary { background-color: #757575; }
    </style>
</head>
<body>
    <div class="container">
        <div class="card full-width">
            <h1>Quick Split</h1>
            <p>A simple, offline tool to split expenses. Add friends, log expenses with multiple payers, and settle up easily.</p>
        </div>

        <div class="card" style="grid-row: span 2;">
            <h2>1. My Friends List</h2>
            <p>Add friends here. This list is saved permanently.</p>
            <div class="input-group">
                <input type="text" id="friend-name-input" placeholder="Enter friend's name">
            </div>
            <button id="add-friend-btn">Save Friend</button>
            <ul id="friends-list"></ul>
        </div>
        
        <div class="card full-width" style="grid-column: 1 / -1;">
            <h2>2. Add Expense</h2>
            <form id="expense-form">
                <div class="input-group">
                    <label for="description">Description</label>
                    <input type="text" id="description" placeholder="e.g., Dinner, Groceries" required>
                </div>

                <div class="input-group">
                    <label>Total Amount: <span id="total-amount-display">₹0.00</span></label>
                </div>

                <div class="input-group">
                    <label>Who Paid? (Add one or more payers)</label>
                    <div class="add-payer-group">
                        <select id="payer-select"></select>
                        <input type="number" id="payer-amount" placeholder="Amount" step="0.01" min="0.01">
                        <button type="button" class="secondary" id="add-payer-btn">Add Payer</button>
                    </div>
                    <ul id="payers-list"></ul>
                </div>

                <div class="input-group">
                    <label>Who was involved in this expense?</label>
                    <div id="expense-participants-checkboxes"></div>
                </div>
                
                <div class="input-group">
                    <label>How to split?</label>
                    <div class="split-method-group">
                        <label><input type="radio" name="split-method" value="equally" checked> Equally</label>
                        <label><input type="radio" name="split-method" value="unequally"> Unequally</label>
                    </div>
                </div>

                <div id="unequal-split-container">
                    <p>Enter the amount each person is responsible for:</p>
                    <div id="unequal-split-inputs"></div>
                    <div id="unequal-split-total">Total: ₹0.00 / ₹0.00</div>
                </div>
                
                <button type="submit">Add Expense</button>
            </form>
        </div>

        <div class="card full-width">
            <h2>3. Expenses Log</h2>
            <ul id="expenses-list"></ul>
        </div>

        <div class="card full-width">
            <h2>4. Final Summary</h2>
            <p>Here's the simplest way for everyone to settle up across all expenses:</p>
            <ul id="settlement-summary"></ul>
        </div>
        
        <div class="card full-width">
            <h2>Settings</h2>
            <p>This will permanently delete all logged expenses. Your friends list will not be affected.</p>
            <button class="danger" id="clear-data-btn">Clear All Expenses</button>
        </div>
    </div>
    
    <div class="modal-overlay" id="confirmation-modal">
        <div class="modal-content">
            <p id="modal-text">Are you sure?</p>
            <div class="modal-buttons">
                <button class="button-secondary" id="modal-cancel">Cancel</button>
                <button class="danger" id="modal-confirm">Confirm</button>
            </div>
        </div>
    </div>

    <script>
        // Global variables
        let friends = [];
        let expenses = [];
        let currentPayers = [];
        let onConfirmCallback = null;
        
        // Initialize app when DOM is loaded
        document.addEventListener('DOMContentLoaded', function() {
            initializeApp();
        });

        function initializeApp() {
            // Load saved data with better error handling
            loadSavedData();
            
            // Setup event listeners
            setupEventListeners();
            
            // Update UI
            updateAllUI();
            
            console.log('App initialized successfully', { friends, expenses });
        }

        function loadSavedData() {
            try {
                const savedFriends = localStorage.getItem('quickSplitFriends');
                if (savedFriends && savedFriends !== 'null' && savedFriends !== 'undefined') {
                    const parsedFriends = JSON.parse(savedFriends);
                    if (Array.isArray(parsedFriends)) {
                        friends = parsedFriends;
                    }
                }
            } catch (error) {
                console.warn('Error loading friends data, clearing corrupted data:', error);
                localStorage.removeItem('quickSplitFriends');
                friends = [];
            }

            try {
                const savedExpenses = localStorage.getItem('quickSplitExpenses');
                if (savedExpenses && savedExpenses !== 'null' && savedExpenses !== 'undefined') {
                    const parsedExpenses = JSON.parse(savedExpenses);
                    if (Array.isArray(parsedExpenses)) {
                        expenses = parsedExpenses;
                    }
                }
            } catch (error) {
                console.warn('Error loading expenses data, clearing corrupted data:', error);
                localStorage.removeItem('quickSplitExpenses');
                expenses = [];
            }
        }

        function setupEventListeners() {
            // Add friend button and enter key
            document.getElementById('add-friend-btn').addEventListener('click', addFriend);
            document.getElementById('friend-name-input').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    addFriend();
                }
            });

            // Add payer button
            document.getElementById('add-payer-btn').addEventListener('click', addPayerToExpense);
            
            // Expense form
            document.getElementById('expense-form').addEventListener('submit', function(e) {
                e.preventDefault();
                addExpense();
            });

            // Split method change
            document.querySelectorAll('input[name="split-method"]').forEach(radio => {
                radio.addEventListener('change', toggleUnequalSplit);
            });

            // Clear data button
            document.getElementById('clear-data-btn').addEventListener('click', confirmClearAllData);

            // Modal listeners
            setupModalListeners();
        }

        function addFriend() {
            try {
                const nameInput = document.getElementById('friend-name-input');
                const name = nameInput.value.trim();
                
                console.log('Adding friend:', name);
                
                if (!name) {
                    alert('Please enter a name.');
                    return;
                }
                
                if (friends.includes(name)) {
                    alert('This friend is already in your list!');
                    return;
                }
                
                friends.push(name);
                nameInput.value = '';
                
                console.log('Friends array after adding:', friends);
                
                saveFriends();
                updateAllUI();
                
            } catch (error) {
                console.error('Error adding friend:', error);
                alert('Error adding friend. Please try again.');
            }
        }

        function removeFriend(index) {
            try {
                const friendToRemove = friends[index];
                const isFriendInvolved = expenses.some(exp => 
                    exp.participants.includes(friendToRemove) || 
                    exp.payers.some(p => p.name === friendToRemove)
                );

                if (isFriendInvolved) {
                    alert(`Cannot remove ${friendToRemove} as they are part of an existing expense. Please remove related expenses first.`);
                    return;
                }
                
                showConfirmationModal(`Are you sure you want to permanently delete ${friendToRemove}?`, () => {
                    friends.splice(index, 1);
                    saveFriends();
                    updateAllUI();
                });
            } catch (error) {
                console.error('Error removing friend:', error);
            }
        }

        function addPayerToExpense() {
            try {
                const payerSelect = document.getElementById('payer-select');
                const payerAmountInput = document.getElementById('payer-amount');
                const name = payerSelect.value;
                const amount = parseFloat(payerAmountInput.value);

                if (!name || !amount || amount <= 0) {
                    alert("Please select a payer and enter a valid positive amount.");
                    return;
                }
                if (currentPayers.some(p => p.name === name)) {
                    alert(`${name} is already in the payers list for this expense.`);
                    return;
                }

                currentPayers.push({ name, amount });
                payerAmountInput.value = '';
                renderCurrentPayersList();
                updateTotalExpenseAmount();
            } catch (error) {
                console.error('Error adding payer:', error);
            }
        }

        function removePayerFromExpense(index) {
            currentPayers.splice(index, 1);
            renderCurrentPayersList();
            updateTotalExpenseAmount();
        }

        function addExpense() {
            try {
                const description = document.getElementById('description').value;
                const totalAmount = currentPayers.reduce((sum, p) => sum + p.amount, 0);

                if (currentPayers.length === 0) {
                    alert("Please add at least one payer for the expense.");
                    return;
                }

                const splitMethod = document.querySelector('input[name="split-method"]:checked').value;
                const selectedParticipants = Array.from(document.querySelectorAll('#expense-participants-checkboxes input:checked')).map(cb => cb.name);

                if (selectedParticipants.length < 1) {
                    alert("Please select at least one person involved in the expense.");
                    return;
                }
                
                const allPayersAreParticipants = currentPayers.every(p => selectedParticipants.includes(p.name));
                if (!allPayersAreParticipants) {
                    alert("All payers must also be selected as participants in the expense.");
                    return;
                }

                let splits = [];
                if (splitMethod === 'equally') {
                    const numParticipants = selectedParticipants.length;
                    const share = Math.floor((totalAmount / numParticipants) * 100) / 100;
                    let totalSplit = 0;
                    splits = selectedParticipants.map((p, index) => {
                        if (index < numParticipants - 1) {
                            totalSplit += share;
                            return { name: p, amount: share };
                        } else {
                            const remainder = parseFloat((totalAmount - totalSplit).toFixed(2));
                            return { name: p, amount: remainder };
                        }
                    });
                } else {
                    const unequalInputs = document.querySelectorAll('#unequal-split-inputs input');
                    let totalSplitAmount = 0;
                    unequalInputs.forEach(input => {
                        const splitAmount = parseFloat(input.value) || 0;
                        splits.push({ name: input.dataset.name, amount: splitAmount });
                        totalSplitAmount += splitAmount;
                    });
                    if (Math.abs(totalSplitAmount - totalAmount) > 0.01) {
                        alert(`The sum of the unequal splits (₹${totalSplitAmount.toFixed(2)}) does not match the total expense amount (₹${totalAmount.toFixed(2)}).`);
                        return;
                    }
                }
                
                const newExpense = { id: Date.now(), description, amount: totalAmount, payers: [...currentPayers], participants: selectedParticipants, splits };
                expenses.push(newExpense);
                
                // Clear form state after submission
                currentPayers = [];
                document.getElementById('expense-form').reset();
                saveExpenses();
                updateAllUI();
                renderCurrentPayersList();
                updateTotalExpenseAmount();
            } catch (error) {
                console.error('Error adding expense:', error);
                alert('Error adding expense. Please try again.');
            }
        }

        function removeExpense(id) {
            showConfirmationModal(`Are you sure you want to delete this expense?`, () => {
                expenses = expenses.filter(exp => exp.id !== id);
                saveExpenses();
                updateAllUI();
            });
        }
        
        function confirmClearAllData() {
            showConfirmationModal('This will clear all logged expenses. Your friends list will not be affected. Continue?', () => {
                expenses = [];
                saveExpenses();
                updateAllUI();
            });
        }
        
        function toggleUnequalSplit() {
            const container = document.getElementById('unequal-split-container');
            const isUnequal = document.querySelector('input[name="split-method"]:checked').value === 'unequally';
            const selectedParticipants = Array.from(document.querySelectorAll('#expense-participants-checkboxes input:checked')).map(cb => cb.name);

            if (isUnequal && selectedParticipants.length > 0) {
                container.style.display = 'block';
                renderUnequalSplitInputs();
            } else {
                container.style.display = 'none';
            }
        }

        function renderUnequalSplitInputs() {
            const container = document.getElementById('unequal-split-inputs');
            container.innerHTML = '';
            const selectedParticipants = Array.from(document.querySelectorAll('#expense-participants-checkboxes input:checked')).map(cb => cb.name);
            
            selectedParticipants.forEach(name => {
                const row = document.createElement('div');
                row.className = 'unequal-split-row';
                row.innerHTML = `
                    <label for="unequal-${name}">${name}</label>
                    <input type="number" id="unequal-${name}" data-name="${name}" min="0" step="0.01" placeholder="0.00">`;
                container.appendChild(row);
            });
            
            // Add event listeners to new inputs
            container.querySelectorAll('input').forEach(input => {
                input.addEventListener('input', updateUnequalSplitTotal);
            });
            
            updateUnequalSplitTotal();
        }
        
        function updateUnequalSplitTotal() {
            const totalAmount = currentPayers.reduce((sum, p) => sum + p.amount, 0);
            const inputs = document.querySelectorAll('#unequal-split-inputs input');
            let currentSplitTotal = 0;
            inputs.forEach(input => { currentSplitTotal += parseFloat(input.value) || 0; });
            
            const totalDiv = document.getElementById('unequal-split-total');
            totalDiv.textContent = `Total: ₹${currentSplitTotal.toFixed(2)} / ₹${totalAmount.toFixed(2)}`;
            totalDiv.style.color = Math.abs(currentSplitTotal - totalAmount) > 0.01 ? 'var(--danger-color)' : 'var(--primary-color)';
        }

        // Data persistence functions
        function saveFriends() { 
            try {
                localStorage.setItem('quickSplitFriends', JSON.stringify(friends)); 
                console.log('Friends saved:', friends);
            } catch (error) {
                console.error('Error saving friends:', error);
            }
        }
        
        function saveExpenses() { 
            try {
                localStorage.setItem('quickSplitExpenses', JSON.stringify(expenses)); 
            } catch (error) {
                console.error('Error saving expenses:', error);
            }
        }

        // UI Update functions
        function updateAllUI() {
            renderFriendsList();
            renderPayerSelect();
            renderExpenseParticipantCheckboxes();
            renderExpenses();
            calculateAndRenderSummary();
            toggleUnequalSplit();
        }

        function renderFriendsList() {
            const list = document.getElementById('friends-list');
            list.innerHTML = '';
            if (friends.length === 0) {
                list.innerHTML = '<li>No friends saved yet.</li>';
                return;
            }
            friends.forEach((name, index) => {
                const li = document.createElement('li');
                li.innerHTML = `<span>${name}</span> <button class="danger" data-index="${index}">Delete</button>`;
                
                // Add event listener to delete button
                li.querySelector('button').addEventListener('click', (e) => {
                    e.stopPropagation();
                    removeFriend(parseInt(e.target.dataset.index));
                });
                
                list.appendChild(li);
            });
        }

        function renderPayerSelect() {
            const select = document.getElementById('payer-select');
            select.innerHTML = '';
            if (friends.length === 0) {
                select.innerHTML = '<option disabled>Add friends first</option>';
            } else {
                friends.forEach(name => {
                    const option = document.createElement('option');
                    option.value = name; 
                    option.textContent = name;
                    select.appendChild(option);
                });
            }
        }
        
        function renderCurrentPayersList() {
            const list = document.getElementById('payers-list');
            list.innerHTML = '';
            currentPayers.forEach((payer, index) => {
                const li = document.createElement('li');
                li.innerHTML = `<span>${payer.name} paid ₹${payer.amount.toFixed(2)}</span> <button type="button" class="danger" data-index="${index}">Remove</button>`;
                
                // Add event listener to remove button
                li.querySelector('button').addEventListener('click', (e) => {
                    removePayerFromExpense(parseInt(e.target.dataset.index));
                });
                
                list.appendChild(li);
            });
        }

        function updateTotalExpenseAmount() {
            const totalAmount = currentPayers.reduce((sum, p) => sum + p.amount, 0);
            document.getElementById('total-amount-display').textContent = `₹${totalAmount.toFixed(2)}`;
            updateUnequalSplitTotal();
        }

        function renderExpenseParticipantCheckboxes() {
            const container = document.getElementById('expense-participants-checkboxes');
            container.innerHTML = '';
            if (friends.length === 0) {
                container.innerHTML = '<p>Add friends to your list.</p>'; 
                return;
            }
            friends.forEach(name => {
                const label = document.createElement('label');
                label.innerHTML = `<input type="checkbox" name="${name}"> ${name}`;
                
                // Add event listener to checkbox
                label.querySelector('input').addEventListener('change', toggleUnequalSplit);
                
                container.appendChild(label);
            });
        }

        function toggleExpenseDetails(liElement) {
            liElement.classList.toggle('active');
            const breakdownDiv = liElement.querySelector('.expense-breakdown');
            breakdownDiv.style.display = liElement.classList.contains('active') ? 'block' : 'none';
        }

        function renderExpenses() {
            const list = document.getElementById('expenses-list');
            list.innerHTML = '';
            if (expenses.length === 0) {
                list.innerHTML = '<li>No expenses logged yet.</li>'; 
                return;
            }
            expenses.slice().reverse().forEach(exp => {
                const li = document.createElement('li');
                
                const payersString = exp.payers.length === 1 
                    ? `${exp.payers[0].name}`
                    : `${exp.payers.length} people`;

                let breakdownHTML = '<h4>Settlement Details:</h4>';
                exp.splits.forEach(split => {
                    const totalPaid = exp.payers
                        .filter(p => p.name === split.name)
                        .reduce((sum, p) => sum + p.amount, 0);
                    
                    const balance = totalPaid - split.amount;
                    if (Math.abs(balance) > 0.01) {
                        const balanceText = balance > 0 
                            ? `is owed ₹${balance.toFixed(2)}` 
                            : `owes ₹${(-balance).toFixed(2)}`;
                        breakdownHTML += `<p><strong>${split.name}</strong>: ${balanceText}</p>`;
                    } else {
                        breakdownHTML += `<p><strong>${split.name}</strong>: settled</p>`;
                    }
                });

                if (exp.payers.length > 1) {
                    breakdownHTML += '<h4>Payment Details:</h4>';
                    exp.payers.forEach(payer => {
                        breakdownHTML += `<p><strong>${payer.name}</strong> paid ₹${payer.amount.toFixed(2)}</p>`;
                    });
                }

                li.innerHTML = `
                    <div class="expense-header">
                        <div class="expense-details">
                            <b>${exp.description}</b>
                            <div class="expense-info">Total ₹${exp.amount.toFixed(2)} | Paid by ${payersString}</div>
                        </div>
                        <div class="expense-actions">
                            <span class="toggle-arrow">▼</span>
                            <button class="danger" data-id="${exp.id}">Delete</button>
                        </div>
                    </div>
                    <div class="expense-participants-list">
                        Split between: ${exp.participants.join(', ')}
                    </div>
                    <div class="expense-breakdown">${breakdownHTML}</div>`;
                
                // Add event listeners
                li.addEventListener('click', (e) => {
                    if (!e.target.closest('button')) {
                        toggleExpenseDetails(li);
                    }
                });
                
                li.querySelector('.expense-actions button').addEventListener('click', (e) => {
                    e.stopPropagation();
                    removeExpense(parseInt(e.target.dataset.id));
                });
                
                list.appendChild(li);
            });
        }
        
        function calculateAndRenderSummary() {
            const balances = new Map();
            friends.forEach(p => balances.set(p, 0));

            expenses.forEach(exp => {
                exp.payers.forEach(payer => {
                    balances.set(payer.name, balances.get(payer.name) + payer.amount);
                });
                exp.splits.forEach(split => {
                    balances.set(split.name, balances.get(split.name) - split.amount);
                });
            });

            const debtors = [];
            const creditors = [];
            balances.forEach((amount, name) => {
                const roundedAmount = Math.round(amount * 100) / 100;
                if (roundedAmount < -0.01) {
                    debtors.push({ name, amount: -roundedAmount });
                } else if (roundedAmount > 0.01) {
                    creditors.push({ name, amount: roundedAmount });
                }
            });

            const transactions = [];
            debtors.sort((a, b) => a.amount - b.amount);
            creditors.sort((a, b) => a.amount - b.amount);

            while (debtors.length > 0 && creditors.length > 0) {
                const debtor = debtors[0];
                const creditor = creditors[0];
                const amount = Math.min(debtor.amount, creditor.amount);

                transactions.push({ from: debtor.name, to: creditor.name, amount });

                debtor.amount = parseFloat((debtor.amount - amount).toFixed(2));
                creditor.amount = parseFloat((creditor.amount - amount).toFixed(2));

                if (debtor.amount < 0.01) debtors.shift();
                if (creditor.amount < 0.01) creditors.shift();
            }

            const summaryList = document.getElementById('settlement-summary');
            summaryList.innerHTML = '';
            if (transactions.length === 0) {
                const placeholderText = expenses.length > 0 ? 'All settled up!' : 'Add an expense to see the summary.';
                summaryList.innerHTML = `<li class="placeholder">${placeholderText}</li>`;
            } else {
                transactions.forEach(t => {
                    const li = document.createElement('li');
                    li.innerHTML = `<strong>${t.from}</strong> owes <strong>${t.to}</strong> → <strong>₹${t.amount.toFixed(2)}</strong>`;
                    summaryList.appendChild(li);
                });
            }
        }

        function showConfirmationModal(message, callback) {
            const modal = document.getElementById('confirmation-modal');
            document.getElementById('modal-text').textContent = message;
            onConfirmCallback = callback;
            modal.classList.add('active');
        }

        function hideConfirmationModal() {
            document.getElementById('confirmation-modal').classList.remove('active');
            onConfirmCallback = null;
        }

        function setupModalListeners() {
            const modal = document.getElementById('confirmation-modal');
            document.getElementById('modal-confirm').addEventListener('click', () => {
                if (onConfirmCallback) onConfirmCallback();
                hideConfirmationModal();
            });
            document.getElementById('modal-cancel').addEventListener('click', hideConfirmationModal);
            modal.addEventListener('click', (e) => { 
                if (e.target === modal) hideConfirmationModal(); 
            });
        }
    </script>
</body>
</html>